# =============================================
# Docker Compose - ISIC Odoo Unified (VPS-4)
# Production + Staging + Nginx Front + Redis + Backup
# =============================================
# Usage:
#   docker compose -f docker/docker-compose.vps4.yml --env-file .env.vps4 up -d

name: isic-odoo-vps4

services:
  # === PRODUCTION ===

  db-prod:
    image: postgres:16-alpine
    container_name: isic-db-prod
    restart: always
    logging: &log-small
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      POSTGRES_USER: ${PROD_DB_USER}
      POSTGRES_PASSWORD: ${PROD_DB_PASSWORD}
      POSTGRES_DB: ${PROD_DB_NAME}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-prod-data:/var/lib/postgresql/data/pgdata
      - postgres-backup:/backup
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PROD_DB_USER} -d ${PROD_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  pgbouncer-prod:
    image: edoburu/pgbouncer:latest
    container_name: isic-pgbouncer-prod
    restart: always
    logging: *log-small
    depends_on:
      db-prod:
        condition: service_healthy
    environment:
      DB_HOST: db-prod
      DB_PORT: 5432
      DB_USER: ${PROD_DB_USER}
      DB_PASSWORD: ${PROD_DB_PASSWORD}
      POOL_MODE: session
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 32
      MIN_POOL_SIZE: 10
      MAX_DB_CONNECTIONS: 100
      IGNORE_STARTUP_PARAMETERS: "extra_float_digits,search_path"
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "127.0.0.1", "-p", "5432"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 128M

  odoo-prod:
    image: isic-odoo:latest
    container_name: isic-odoo-prod
    restart: always
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    depends_on:
      db-prod:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      DB_HOST: db-prod
      DB_PORT: 5432
      DB_USER: ${PROD_DB_USER}
      DB_PASSWORD: ${PROD_DB_PASSWORD}
      DB_NAME: ${PROD_DB_NAME}
      DB_MAXCONN: 64
      HTTP_PORT: 8069
      PROXY_MODE: "True"
      WORKERS: ${PROD_WORKERS:-4}
      MAX_CRON_THREADS: 2
      ADMIN_PASSWD: ${PROD_ADMIN_PASSWD}
      LIST_DB: "False"
      LOG_LEVEL: warn
      LOG_HANDLER: ":WARNING"
      LIMIT_MEMORY_HARD: 2684354560
      LIMIT_MEMORY_SOFT: 2147483648
      LIMIT_TIME_CPU: 60
      LIMIT_TIME_REAL: 120
      LIMIT_REQUEST: 8192
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PREFIX: odoo_prod_session
      SMTP_SERVER: ${SMTP_SERVER:-False}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-False}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-False}
      SMTP_SSL: "True"
    volumes:
      - odoo-prod-data:/var/lib/odoo
      - odoo-prod-logs:/var/log/odoo
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # === STAGING ===

  db-staging:
    image: postgres:16-alpine
    container_name: isic-db-staging
    restart: always
    logging: *log-small
    environment:
      POSTGRES_USER: ${STAGING_DB_USER}
      POSTGRES_PASSWORD: ${STAGING_DB_PASSWORD}
      POSTGRES_DB: ${STAGING_DB_NAME}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-staging-data:/var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${STAGING_DB_USER} -d ${STAGING_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  pgbouncer-staging:
    image: edoburu/pgbouncer:latest
    container_name: isic-pgbouncer-staging
    restart: always
    logging: *log-small
    depends_on:
      db-staging:
        condition: service_healthy
    environment:
      DB_HOST: db-staging
      DB_PORT: 5432
      DB_USER: ${STAGING_DB_USER}
      DB_PASSWORD: ${STAGING_DB_PASSWORD}
      POOL_MODE: session
      MAX_CLIENT_CONN: 100
      DEFAULT_POOL_SIZE: 16
      MIN_POOL_SIZE: 5
      MAX_DB_CONNECTIONS: 50
      IGNORE_STARTUP_PARAMETERS: "extra_float_digits,search_path"
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "127.0.0.1", "-p", "5432"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 128M

  odoo-staging:
    image: isic-odoo:latest
    container_name: isic-odoo-staging
    restart: always
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    depends_on:
      db-staging:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      DB_HOST: db-staging
      DB_PORT: 5432
      DB_USER: ${STAGING_DB_USER}
      DB_PASSWORD: ${STAGING_DB_PASSWORD}
      DB_NAME: ${STAGING_DB_NAME}
      DB_MAXCONN: 32
      HTTP_PORT: 8069
      PROXY_MODE: "True"
      WORKERS: ${STAGING_WORKERS:-2}
      MAX_CRON_THREADS: 1
      ADMIN_PASSWD: ${STAGING_ADMIN_PASSWD}
      LIST_DB: "False"
      LOG_LEVEL: info
      LIMIT_MEMORY_HARD: 2684354560
      LIMIT_MEMORY_SOFT: 2147483648
      LIMIT_TIME_CPU: 120
      LIMIT_TIME_REAL: 300
      LIMIT_REQUEST: 8192
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PREFIX: odoo_staging_session
      SMTP_SERVER: ${SMTP_SERVER:-False}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-False}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-False}
      SMTP_SSL: ${SMTP_SSL:-True}
    volumes:
      - odoo-staging-data:/var/lib/odoo
      - odoo-staging-logs:/var/log/odoo
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # === SHARED ===

  redis:
    image: redis:7-alpine
    container_name: isic-redis-vps
    restart: always
    logging: *log-small
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - isic-internal
    deploy:
      resources:
        limits:
          memory: 256M

  nginx:
    image: nginx:alpine
    container_name: isic-nginx-vps4
    restart: always
    logging: *log-small
    depends_on:
      - odoo-prod
      - odoo-staging
    volumes:
      - ./nginx/vps4.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot-data:/var/www/certbot:ro
      - nginx-cache:/var/cache/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - isic-internal
      - isic-external
    deploy:
      resources:
        limits:
          memory: 256M

  backup:
    image: postgres:16-alpine
    container_name: isic-backup-vps
    restart: always
    logging: *log-small
    depends_on:
      - db-prod
    environment:
      POSTGRES_USER: ${PROD_DB_USER}
      POSTGRES_PASSWORD: ${PROD_DB_PASSWORD}
      POSTGRES_DB: ${PROD_DB_NAME}
      PGHOST: db-prod
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    volumes:
      - postgres-backup:/backup
      - ../scripts/backup.sh:/backup.sh:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "0 2 * * * /backup.sh" > /var/spool/cron/crontabs/root
        crond -f -l 2
    networks:
      - isic-internal

volumes:
  postgres-prod-data:
    name: isic-postgres-prod-vps
  postgres-backup:
    name: isic-backup-vps
  odoo-prod-data:
    name: isic-odoo-data-prod-vps
  odoo-prod-logs:
    name: isic-odoo-logs-prod-vps
  postgres-staging-data:
    name: isic-postgres-staging-vps
  odoo-staging-data:
    name: isic-odoo-data-staging-vps
  odoo-staging-logs:
    name: isic-odoo-logs-staging-vps
  redis-data:
    name: isic-redis-vps
  nginx-cache:
    name: isic-nginx-cache-vps
  certbot-data:
    name: isic-certbot-vps

networks:
  isic-internal:
    name: isic-internal-vps
    driver: bridge
    internal: true
  isic-external:
    name: isic-external-vps
    driver: bridge
